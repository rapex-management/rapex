<!DOCTYPE html>
<html>
<head>
    <title>Test Merchant Login Flow</title>
</head>
<body>
    <h1>Testing Merchant Login Flow</h1>
    <button onclick="testLogin()">Test Login</button>
    <div id="results"></div>

    <script>
        async function testLogin() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>Testing login flow...</p>';
            
            try {
                console.log('üîê Starting login test...');
                
                // Test login
                const loginResponse = await fetch('http://localhost:3000/api/proxy/merchant/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        identifier: 'testmerchant',
                        password: 'testpass123'
                    })
                });
                
                console.log('üåê Login response:', loginResponse.status);
                
                if (!loginResponse.ok) {
                    throw new Error(`Login failed: ${loginResponse.status}`);
                }
                
                const loginData = await loginResponse.json();
                console.log('‚úÖ Login successful:', loginData);
                
                // Store data like the frontend does
                localStorage.setItem('merchant_token', loginData.access);
                localStorage.setItem('merchant_refresh_token', loginData.refresh);
                localStorage.setItem('merchant', JSON.stringify({
                    id: loginData.id,
                    email: loginData.email,
                    merchant_name: loginData.merchant_name,
                    owner_name: loginData.owner_name,
                    phone: loginData.phone,
                    status: loginData.status,
                    username: loginData.username
                }));
                
                console.log('üíæ Data stored');
                
                // Test token verification
                const verifyResponse = await fetch('http://localhost:3000/api/proxy/merchant/verify-token', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${loginData.access}`,
                        'Content-Type': 'application/json',
                    }
                });
                
                console.log('üîç Token verification response:', verifyResponse.status);
                
                if (verifyResponse.ok) {
                    const verifyData = await verifyResponse.json();
                    console.log('‚úÖ Token verification successful:', verifyData);
                    
                    resultsDiv.innerHTML = `
                        <h3>‚úÖ Login Test Successful!</h3>
                        <p><strong>Status:</strong> ${loginData.status}</p>
                        <p><strong>Username:</strong> ${loginData.username}</p>
                        <p><strong>Email:</strong> ${loginData.email}</p>
                        <p><strong>Token Valid:</strong> ${verifyData.valid}</p>
                        <p><a href="http://localhost:3000/merchant/dashboard" target="_blank">Test Dashboard Access</a></p>
                    `;
                } else {
                    throw new Error(`Token verification failed: ${verifyResponse.status}`);
                }
                
            } catch (error) {
                console.error('‚ùå Test failed:', error);
                resultsDiv.innerHTML = `<p style="color: red;">‚ùå Test failed: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
